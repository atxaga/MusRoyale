Index: .idea/deploymentTargetSelector.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"deploymentTargetSelector\">\r\n    <selectionStates>\r\n      <SelectionState runConfigName=\"app\">\r\n        <option name=\"selectionMode\" value=\"DROPDOWN\" />\r\n        <DropdownSelection timestamp=\"2026-01-09T10:34:16.757902100Z\">\r\n          <Target type=\"DEFAULT_BOOT\">\r\n            <handle>\r\n              <DeviceId pluginId=\"LocalEmulator\" identifier=\"path=C:\\Users\\ik012982i18\\.android\\avd\\Medium_Phone.avd\" />\r\n            </handle>\r\n          </Target>\r\n        </DropdownSelection>\r\n        <DialogSelection />\r\n      </SelectionState>\r\n    </selectionStates>\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/deploymentTargetSelector.xml b/.idea/deploymentTargetSelector.xml
--- a/.idea/deploymentTargetSelector.xml	(revision 2fdb24e60a352bf8a4a246b36dc41ff11ca376db)
+++ b/.idea/deploymentTargetSelector.xml	(date 1768294346417)
@@ -4,7 +4,7 @@
     <selectionStates>
       <SelectionState runConfigName="app">
         <option name="selectionMode" value="DROPDOWN" />
-        <DropdownSelection timestamp="2026-01-09T10:34:16.757902100Z">
+        <DropdownSelection timestamp="2026-01-13T08:51:22.566928200Z">
           <Target type="DEFAULT_BOOT">
             <handle>
               <DeviceId pluginId="LocalEmulator" identifier="path=C:\Users\ik012982i18\.android\avd\Medium_Phone.avd" />
Index: app/src/main/java/com/example/musroyale/PartidaActivity.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.musroyale\r\n\r\nimport android.os.Bundle\r\nimport android.widget.ImageButton\r\nimport android.widget.ImageView\r\nimport android.widget.Toast\r\nimport androidx.appcompat.app.AppCompatActivity\r\nimport androidx.lifecycle.lifecycleScope\r\nimport kotlinx.coroutines.Dispatchers\r\nimport kotlinx.coroutines.delay\r\nimport kotlinx.coroutines.launch\r\nimport kotlinx.coroutines.withContext\r\nimport kotlinx.coroutines.withTimeoutOrNull\r\nimport java.io.BufferedReader\r\nimport java.io.InputStreamReader\r\nimport java.net.InetSocketAddress\r\nimport java.net.Socket\r\n\r\nclass PartidaActivity : AppCompatActivity() {\r\n    private val serverHost = \"34.233.112.247\"\r\n    private val serverPort = 13000\r\n    private val connectTimeoutMs = 20000\r\n    private val currentCards = mutableListOf<String>()\r\n    private val selectedIndices = mutableSetOf<Int>()\r\n\r\n    private lateinit var bottomCard1: ImageView\r\n    private lateinit var bottomCard2: ImageView\r\n    private lateinit var bottomCard3: ImageView\r\n    private lateinit var bottomCard4: ImageView\r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        super.onCreate(savedInstanceState)\r\n        setContentView(R.layout.activity_partida)\r\n\r\n        // Listeners para iconos de chat y camara\r\n        val btnChat = findViewById<ImageButton>(R.id.buttonChat)\r\n        val btnCam = findViewById<ImageButton>(R.id.buttonCamara)\r\n\r\n        bottomCard1 = findViewById(R.id.bottomCard1)\r\n        bottomCard2 = findViewById(R.id.bottomCard2)\r\n        bottomCard3 = findViewById(R.id.bottomCard3)\r\n        bottomCard4 = findViewById(R.id.bottomCard4)\r\n\r\n        // Inicial alphas y listeners de selección (toggle)\r\n        bottomCard1.alpha = 1f\r\n        bottomCard2.alpha = 1f\r\n        bottomCard3.alpha = 1f\r\n        bottomCard4.alpha = 1f\r\n\r\n        setupCardClick(bottomCard1, 0)\r\n        setupCardClick(bottomCard2, 1)\r\n        setupCardClick(bottomCard3, 2)\r\n        setupCardClick(bottomCard4, 3)\r\n\r\n\r\n        btnCam?.setOnClickListener {\r\n            Toast.makeText(this, \"Abrir cámara (placeholder)\", Toast.LENGTH_SHORT).show()\r\n            // TODO: abrir cámara / compartir vídeo\r\n        }\r\n        partidaHasi()\r\n    }\r\n    private fun setupCardClick(view: ImageView, index: Int) {\r\n        view.setOnClickListener {\r\n            if (selectedIndices.contains(index)) {\r\n                selectedIndices.remove(index)\r\n                view.alpha = 1f\r\n            } else {\r\n                selectedIndices.add(index)\r\n                view.alpha = 0.5f\r\n            }\r\n        }\r\n    }\r\n    fun partidaHasi(){\r\n        val bottomCard1 = findViewById<android.widget.ImageView>(R.id.bottomCard1)\r\n        lifecycleScope.launch(Dispatchers.IO) {\r\n            var socket: Socket? = null\r\n            try {\r\n                socket = Socket()\r\n                socket.connect(InetSocketAddress(serverHost, serverPort), connectTimeoutMs)\r\n\r\n                val reader = BufferedReader(InputStreamReader(socket.getInputStream()))\r\n                val writer = socket.getOutputStream().bufferedWriter()\r\n\r\n                var turno = 0\r\n                repeat(4){\r\n                    turno++;\r\n                    val karta = reader.readLine()\r\n                    currentCards.add(karta)\r\n                    val resId = resources.getIdentifier(karta, \"drawable\", packageName)\r\n                    if (turno == 1){\r\n                        bottomCard1?.setImageResource(resId)\r\n                    }else if (turno == 2) {\r\n                        val bottomCard2 = findViewById<android.widget.ImageView>(R.id.bottomCard2)\r\n                        bottomCard2?.setImageResource(resId)\r\n                    }else if (turno == 3) {\r\n                        val bottomCard3 = findViewById<android.widget.ImageView>(R.id.bottomCard3)\r\n                        bottomCard3?.setImageResource(resId)\r\n                    }else if (turno == 4) {\r\n                        val bottomCard4 = findViewById<android.widget.ImageView>(R.id.bottomCard4)\r\n                        bottomCard4?.setImageResource(resId)\r\n                    }\r\n                }\r\n\r\n                //Lehenengo jokalariaren erabakia bidaltzen da\r\n                val erabakia = \"mus\"\r\n                writer.write(\"$erabakia\\n\")\r\n                writer.flush()\r\n\r\n                val aukeratuta = reader.readLine()\r\n                if(aukeratuta == \"mus\"){\r\n                    delay(10_000)\r\n\r\n                    val discard = withContext(Dispatchers.Main) {\r\n                        buildDiscardString()\r\n                    }\r\n\r\n                    // Enviar al servidor\r\n                    writer.write(\"$discard\\n\")\r\n                    writer.flush()\r\n\r\n                }\r\n\r\n            }catch (e: Exception) {\r\n                withContext(Dispatchers.Main) {\r\n                    Toast.makeText(this@PartidaActivity, \"Error TCP: ${e.message}\", Toast.LENGTH_LONG).show()\r\n                }\r\n            } finally {\r\n                try { socket?.close() } catch (_: Exception) {}\r\n            }\r\n        }\r\n    }\r\n    private fun buildDiscardString(): String {\r\n        if (selectedIndices.isEmpty()) return \"*\" // solo marcador final\r\n        val ordered = selectedIndices.sorted()\r\n        val parts = ordered.mapNotNull { idx -> currentCards.getOrNull(idx) }\r\n        return parts.joinToString(\"-\") + \"*\"\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/musroyale/PartidaActivity.kt b/app/src/main/java/com/example/musroyale/PartidaActivity.kt
--- a/app/src/main/java/com/example/musroyale/PartidaActivity.kt	(revision 2fdb24e60a352bf8a4a246b36dc41ff11ca376db)
+++ b/app/src/main/java/com/example/musroyale/PartidaActivity.kt	(date 1768295756963)
@@ -69,11 +69,11 @@
             }
         }
     }
-    fun partidaHasi(){
-        val bottomCard1 = findViewById<android.widget.ImageView>(R.id.bottomCard1)
+    fun partidaHasi() {
         lifecycleScope.launch(Dispatchers.IO) {
             var socket: Socket? = null
             try {
+                // Conectar al servidor
                 socket = Socket()
                 socket.connect(InetSocketAddress(serverHost, serverPort), connectTimeoutMs)
 
@@ -81,45 +81,59 @@
                 val writer = socket.getOutputStream().bufferedWriter()
 
                 var turno = 0
-                repeat(4){
-                    turno++;
-                    val karta = reader.readLine()
-                    currentCards.add(karta)
-                    val resId = resources.getIdentifier(karta, "drawable", packageName)
-                    if (turno == 1){
-                        bottomCard1?.setImageResource(resId)
-                    }else if (turno == 2) {
-                        val bottomCard2 = findViewById<android.widget.ImageView>(R.id.bottomCard2)
-                        bottomCard2?.setImageResource(resId)
-                    }else if (turno == 3) {
-                        val bottomCard3 = findViewById<android.widget.ImageView>(R.id.bottomCard3)
-                        bottomCard3?.setImageResource(resId)
-                    }else if (turno == 4) {
-                        val bottomCard4 = findViewById<android.widget.ImageView>(R.id.bottomCard4)
-                        bottomCard4?.setImageResource(resId)
-                    }
-                }
+                var partidaActiva = true
+
+                while (partidaActiva) {
+                    val serverMsg = reader.readLine() ?: break // cliente desconectado
+                    when (serverMsg) {
+                        "CARDS" -> {
+                            // Recibir las 4 cartas iniciales
+                            repeat(4) { i ->
+                                val karta = reader.readLine() ?: return@launch
+                                currentCards.add(karta)
+                                // Actualizar UI en el hilo principal
+                                withContext(Dispatchers.Main) {
+                                    val resId = resources.getIdentifier(karta, "drawable", packageName)
+                                    when(i){
+                                        0 -> bottomCard1.setImageResource(resId)
+                                        1 -> bottomCard2.setImageResource(resId)
+                                        2 -> bottomCard3.setImageResource(resId)
+                                        3 -> bottomCard4.setImageResource(resId)
+                                    }
+                                }
+                            }
+                        }
 
-                //Lehenengo jokalariaren erabakia bidaltzen da
-                val erabakia = "mus"
-                writer.write("$erabakia\n")
-                writer.flush()
-
-                val aukeratuta = reader.readLine()
-                if(aukeratuta == "mus"){
-                    delay(10_000)
-
-                    val discard = withContext(Dispatchers.Main) {
-                        buildDiscardString()
-                    }
+                        "TURN" -> {
+                            // Es tu turno de decidir
+                            // Por ahora siempre hacemos "mus" (puedes cambiar según UI)
+                            val erabakia = "mus"
+                            writer.write("$erabakia\n")
+                            writer.flush()
+                        }
 
-                    // Enviar al servidor
-                    writer.write("$discard\n")
-                    writer.flush()
+                        "ALL_MUS" -> {
+                            // Todos dijeron mus, ahora descartes
+                            val discard = withContext(Dispatchers.Main) { buildDiscardString() }
+                            writer.write("$discard\n")
+                            writer.flush()
+                        }
 
+                        "END_GAME" -> {
+                            // Fin de la partida
+                            partidaActiva = false
+                        }
+
+                        else -> {
+                            // Mensajes inesperados
+                            withContext(Dispatchers.Main) {
+                                Toast.makeText(this@PartidaActivity, "Mensaje servidor: $serverMsg", Toast.LENGTH_SHORT).show()
+                            }
+                        }
+                    }
                 }
 
-            }catch (e: Exception) {
+            } catch (e: Exception) {
                 withContext(Dispatchers.Main) {
                     Toast.makeText(this@PartidaActivity, "Error TCP: ${e.message}", Toast.LENGTH_LONG).show()
                 }
@@ -128,6 +142,7 @@
             }
         }
     }
+
     private fun buildDiscardString(): String {
         if (selectedIndices.isEmpty()) return "*" // solo marcador final
         val ordered = selectedIndices.sorted()
